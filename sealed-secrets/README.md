# Sealed Secrets

Sealed Secrets are "one-way" encrypted K8s Secrets that can be created by anyone, but can only be decrypted by the controller running in the target cluster recovering the original object.

To read more on Sealed Secrets here:
https://artifacthub.io/packages/helm/bitnami-labs/sealed-secrets

To read more about Kubeseal, go here:
https://github.com/bitnami-labs/sealed-secrets

## Using Kubeseal

```bash
# Create a json/yaml-encoded Secret somehow:
# (note use of `--dry-run` - this is just a local file!)
echo -n bar | kubectl create secret generic mysecret --dry-run=client --from-file=foo=/dev/stdin -o yaml > mysecret.yaml

# This is the important bit:
kubeseal --controller-name sealed-secrets \
    --controller-namespace kubeseal \
    -f mysecret.yaml \
    -w mysealedsecret.yaml

# At this point mysealedsecret.json is safe to upload to Github, post on Twitter, etc.

# Eventually:
kubectl create -f mysealedsecret.yaml

# Profit!
kubectl get secret mysecret
```

A `.env` file can be converted into a Kubernetes secret like so:

```bash
kubectl create secret generic my-secret --from-env-file=.env
```

## Saving the Private Key

The private key is crucial for decrypting Sealed Secrets. Losing it will make it impossible to recover or unseal your secrets.
K9s can be used to inspect and decode the `sealed-secrets-key` in the cluster.

To save the secret generated by Sealed Secrets, run:

```bash
SECRET_NAME=$(kubectl get secret --namespace kubeseal | grep sealed-secrets-key | cut -d ' ' -f1)
kubectl get secret $SECRET_NAME --namespace kubeseal -o json | jq -r '.data."tls.crt"' | base64 -d > sealed-secrets.crt
kubectl get secret $SECRET_NAME --namespace kubeseal -o json | jq -r '.data."tls.key"' | base64 -d > sealed-secrets.key
```

This will save the certificate (`sealed-secrets.crt`) and the private key (`sealed-secrets.key`). **SAVE THESE SOMEWHERE SAFE!!**

## Restoring the Private Key

In the event that the `sealed-secrets-key` gets destroyed, save your certificate and private key to `sealed-secrets.crt` and `sealed-secrets.key` respectively. Then run these commands to restore the secret:

```bash
kubectl create secret tls sealed-secrets-key --cert sealed-secrets.crt --key sealed-secrets.key --namespace kubeseal
```

If everything is successful, the logs of the sealed-secrets pod will post this:

```logs
time=2025-03-19T21:21:07.078Z level=INFO msg="Starting sealed-secrets controller" version=v0.28.0
time=2025-03-19T21:21:07.079Z level=INFO msg="Searching for existing private keys"
time=2025-03-19T21:21:07.087Z level=INFO msg="registered private key" secretname=sealed-secrets-key
time=2025-03-19T21:21:07.087Z level=INFO msg="HTTP server serving" addr=:8080
time=2025-03-19T21:21:07.087Z level=INFO msg="HTTP metrics server serving" addr=:8081
```

